# Alison K Wright, Evangelos Kontopantelis, Richard Emsley, Ian Buchan, Mamas A Mamas, Naveed Sattar, Darren M Ashcroft, Martin M Rutter, 2024.

import sys, csv, re

codes = [{"code":"B306000","system":"readv2"},{"code":"B340000","system":"readv2"},{"code":"B03z.00","system":"readv2"},{"code":"B022.00","system":"readv2"},{"code":"B....00","system":"readv2"},{"code":"B440.00","system":"readv2"},{"code":"Byu5A00","system":"readv2"},{"code":"B312400","system":"readv2"},{"code":"B306200","system":"readv2"},{"code":"B431000","system":"readv2"},{"code":"B525.00","system":"readv2"},{"code":"B517300","system":"readv2"},{"code":"B22z.00","system":"readv2"},{"code":"B574000","system":"readv2"},{"code":"B551.00","system":"readv2"},{"code":"B333400","system":"readv2"},{"code":"B550500","system":"readv2"},{"code":"B591.00","system":"readv2"},{"code":"B336400","system":"readv2"},{"code":"B081.00","system":"readv2"},{"code":"B221100","system":"readv2"},{"code":"B23..00","system":"readv2"},{"code":"B225.00","system":"readv2"},{"code":"B55..00","system":"readv2"},{"code":"B071z00","system":"readv2"},{"code":"B311000","system":"readv2"},{"code":"B300C00","system":"readv2"},{"code":"B334z00","system":"readv2"},{"code":"B300900","system":"readv2"},{"code":"B18y300","system":"readv2"},{"code":"B011z00","system":"readv2"},{"code":"B150.00","system":"readv2"},{"code":"Byu..00","system":"readv2"},{"code":"B055100","system":"readv2"},{"code":"B62zz11","system":"readv2"},{"code":"B142000","system":"readv2"},{"code":"B576000","system":"readv2"},{"code":"ZV10018","system":"readv2"},{"code":"B308200","system":"readv2"},{"code":"B4A..11","system":"readv2"},{"code":"B575000","system":"readv2"},{"code":"B231.00","system":"readv2"},{"code":"B222000","system":"readv2"},{"code":"B200000","system":"readv2"},{"code":"B62..00","system":"readv2"},{"code":"Bz...00","system":"readv2"},{"code":"B517200","system":"readv2"},{"code":"ZV10300","system":"readv2"},{"code":"B550400","system":"readv2"},{"code":"B34z.00","system":"readv2"},{"code":"B241.00","system":"readv2"},{"code":"B63z.00","system":"readv2"},{"code":"B33..00","system":"readv2"},{"code":"B62z.00","system":"readv2"},{"code":"B310100","system":"readv2"},{"code":"B306100","system":"readv2"},{"code":"B180.00","system":"readv2"},{"code":"B308800","system":"readv2"},{"code":"B441.00","system":"readv2"},{"code":"ZV10512","system":"readv2"},{"code":"B308100","system":"readv2"},{"code":"B580.00","system":"readv2"},{"code":"B4A0.00","system":"readv2"},{"code":"B073.00","system":"readv2"},{"code":"B055z00","system":"readv2"},{"code":"B305.00","system":"readv2"},{"code":"B307200","system":"readv2"},{"code":"B523z00","system":"readv2"},{"code":"B307000","system":"readv2"},{"code":"B482.00","system":"readv2"},{"code":"B551z00","system":"readv2"},{"code":"B223000","system":"readv2"},{"code":"B174.00","system":"readv2"},{"code":"B307.00","system":"readv2"},{"code":"B337800","system":"readv2"},{"code":"B304200","system":"readv2"},{"code":"B010z00","system":"readv2"},{"code":"B522.00","system":"readv2"},{"code":"B13z.00","system":"readv2"},{"code":"B120.00","system":"readv2"},{"code":"B11z.00","system":"readv2"},{"code":"B34y.00","system":"readv2"},{"code":"B575100","system":"readv2"},{"code":"B337200","system":"readv2"},{"code":"B180100","system":"readv2"},{"code":"B04y.00","system":"readv2"},{"code":"B222.00","system":"readv2"},{"code":"B063.00","system":"readv2"},{"code":"ZV10112","system":"readv2"},{"code":"B550300","system":"readv2"},{"code":"Byu2100","system":"readv2"},{"code":"B6...11","system":"readv2"},{"code":"B011100","system":"readv2"},{"code":"B35zz00","system":"readv2"},{"code":"B337600","system":"readv2"},{"code":"B1z2.00","system":"readv2"},{"code":"Byu5.00","system":"readv2"},{"code":"B334000","system":"readv2"},{"code":"B23z.00","system":"readv2"},{"code":"B012.00","system":"readv2"},{"code":"B63y.00","system":"readv2"},{"code":"B300700","system":"readv2"},{"code":"B443.00","system":"readv2"},{"code":"B132.00","system":"readv2"},{"code":"B487.00","system":"readv2"},{"code":"B58y900","system":"readv2"},{"code":"B337700","system":"readv2"},{"code":"B582500","system":"readv2"},{"code":"B162.00","system":"readv2"},{"code":"B180z00","system":"readv2"},{"code":"B1z1z00","system":"readv2"},{"code":"B334.00","system":"readv2"},{"code":"B35..00","system":"readv2"},{"code":"B04z.00","system":"readv2"},{"code":"B054.00","system":"readv2"},{"code":"B586.00","system":"readv2"},{"code":"B131.00","system":"readv2"},{"code":"B311300","system":"readv2"},{"code":"B42..00","system":"readv2"},{"code":"B543.00","system":"readv2"},{"code":"B481.00","system":"readv2"},{"code":"B06..00","system":"readv2"},{"code":"B430000","system":"readv2"},{"code":"B213100","system":"readv2"},{"code":"B18..00","system":"readv2"},{"code":"B161300","system":"readv2"},{"code":"B062100","system":"readv2"},{"code":"B304100","system":"readv2"},{"code":"B540z00","system":"readv2"},{"code":"B301.00","system":"readv2"},{"code":"B585.00","system":"readv2"},{"code":"B520000","system":"readv2"},{"code":"B33..14","system":"readv2"},{"code":"B07..00","system":"readv2"},{"code":"B480.00","system":"readv2"},{"code":"B031.00","system":"readv2"},{"code":"B150z00","system":"readv2"},{"code":"B072.00","system":"readv2"},{"code":"ZV10y12","system":"readv2"},{"code":"B221000","system":"readv2"},{"code":"B07z.00","system":"readv2"},{"code":"B58y000","system":"readv2"},{"code":"B51..00","system":"readv2"},{"code":"B071000","system":"readv2"},{"code":"B577.00","system":"readv2"},{"code":"B51y200","system":"readv2"},{"code":"ZV10417","system":"readv2"},{"code":"ZV10019","system":"readv2"},{"code":"B300200","system":"readv2"},{"code":"B106.00","system":"readv2"},{"code":"B114.00","system":"readv2"},{"code":"B582600","system":"readv2"},{"code":"B512000","system":"readv2"},{"code":"B430z00","system":"readv2"},{"code":"B241200","system":"readv2"},{"code":"ZV10y14","system":"readv2"},{"code":"B11..00","system":"readv2"},{"code":"B10..00","system":"readv2"},{"code":"B117.00","system":"readv2"},{"code":"B55y200","system":"readv2"},{"code":"B307z00","system":"readv2"},{"code":"B553000","system":"readv2"},{"code":"B517.00","system":"readv2"},{"code":"B510400","system":"readv2"},{"code":"B576100","system":"readv2"},{"code":"B520100","system":"readv2"},{"code":"B01y.00","system":"readv2"},{"code":"B310200","system":"readv2"},{"code":"B48y000","system":"readv2"},{"code":"B334100","system":"readv2"},{"code":"B2zz.00","system":"readv2"},{"code":"B582200","system":"readv2"},{"code":"B01z.00","system":"readv2"},{"code":"ZV10015","system":"readv2"},{"code":"B313.00","system":"readv2"},{"code":"B335200","system":"readv2"},{"code":"B311400","system":"readv2"},{"code":"B070.00","system":"readv2"},{"code":"B071.00","system":"readv2"},{"code":"B545000","system":"readv2"},{"code":"B224100","system":"readv2"},{"code":"B121.00","system":"readv2"},{"code":"B18z.00","system":"readv2"},{"code":"B141.00","system":"readv2"},{"code":"B300A00","system":"readv2"},{"code":"B303300","system":"readv2"},{"code":"ZV10.00","system":"readv2"},{"code":"B224.00","system":"readv2"},{"code":"B123.00","system":"readv2"},{"code":"B212.00","system":"readv2"},{"code":"B161000","system":"readv2"},{"code":"B1zz.00","system":"readv2"},{"code":"B51yz00","system":"readv2"},{"code":"B335700","system":"readv2"},{"code":"B030.00","system":"readv2"},{"code":"B58y700","system":"readv2"},{"code":"B43y.00","system":"readv2"},{"code":"B222100","system":"readv2"},{"code":"B305z00","system":"readv2"},{"code":"ZV10414","system":"readv2"},{"code":"ZV10513","system":"readv2"},{"code":"B223z00","system":"readv2"},{"code":"B2zy.00","system":"readv2"},{"code":"B01..00","system":"readv2"},{"code":"B300300","system":"readv2"},{"code":"B312500","system":"readv2"},{"code":"B582.00","system":"readv2"},{"code":"B067.00","system":"readv2"},{"code":"Byu2400","system":"readv2"},{"code":"B350000","system":"readv2"},{"code":"B583z00","system":"readv2"},{"code":"B0z2.00","system":"readv2"},{"code":"B500100","system":"readv2"},{"code":"B550200","system":"readv2"},{"code":"B180200","system":"readv2"},{"code":"ZV10y16","system":"readv2"},{"code":"B010.00","system":"readv2"},{"code":"B584.00","system":"readv2"},{"code":"B34yz00","system":"readv2"},{"code":"B347.00","system":"readv2"},{"code":"B303000","system":"readv2"},{"code":"B430300","system":"readv2"},{"code":"B221z00","system":"readv2"},{"code":"B337400","system":"readv2"},{"code":"Byu4.00","system":"readv2"},{"code":"B453.00","system":"readv2"},{"code":"B442.00","system":"readv2"},{"code":"B52z.00","system":"readv2"},{"code":"B582100","system":"readv2"},{"code":"B520200","system":"readv2"},{"code":"B304400","system":"readv2"},{"code":"B336000","system":"readv2"},{"code":"B22y.00","system":"readv2"},{"code":"B163.00","system":"readv2"},{"code":"B521z00","system":"readv2"},{"code":"B13..00","system":"readv2"},{"code":"B51y000","system":"readv2"},{"code":"B05z.00","system":"readv2"},{"code":"B523.00","system":"readv2"},{"code":"B432.00","system":"readv2"},{"code":"B053.00","system":"readv2"},{"code":"B080.00","system":"readv2"},{"code":"B517z00","system":"readv2"},{"code":"B304300","system":"readv2"},{"code":"B33z.00","system":"readv2"},{"code":"B35z.00","system":"readv2"},{"code":"B51z.00","system":"readv2"},{"code":"B135.00","system":"readv2"},{"code":"B072z00","system":"readv2"},{"code":"B34..00","system":"readv2"},{"code":"B55y000","system":"readv2"},{"code":"B307100","system":"readv2"},{"code":"B51y.00","system":"readv2"},{"code":"ZV10214","system":"readv2"},{"code":"B223.00","system":"readv2"},{"code":"B042.00","system":"readv2"},{"code":"B11..11","system":"readv2"},{"code":"ZV10011","system":"readv2"},{"code":"B485.00","system":"readv2"},{"code":"B151000","system":"readv2"},{"code":"B056.00","system":"readv2"},{"code":"B073z00","system":"readv2"},{"code":"ZV10y11","system":"readv2"},{"code":"B241z00","system":"readv2"},{"code":"B221.00","system":"readv2"},{"code":"B497.00","system":"readv2"},{"code":"B510300","system":"readv2"},{"code":"B583.00","system":"readv2"},{"code":"B153.00","system":"readv2"},{"code":"B052.00","system":"readv2"},{"code":"B205.00","system":"readv2"},{"code":"B303500","system":"readv2"},{"code":"B515.00","system":"readv2"},{"code":"B06z.00","system":"readv2"},{"code":"B138.00","system":"readv2"},{"code":"B200z00","system":"readv2"},{"code":"B516.00","system":"readv2"},{"code":"B224z00","system":"readv2"},{"code":"B31..00","system":"readv2"},{"code":"B313100","system":"readv2"},{"code":"B510500","system":"readv2"},{"code":"B0z1.00","system":"readv2"},{"code":"ZV10111","system":"readv2"},{"code":"B066.00","system":"readv2"},{"code":"B223100","system":"readv2"},{"code":"B200.00","system":"readv2"},{"code":"B540.00","system":"readv2"},{"code":"B521200","system":"readv2"},{"code":"B570.00","system":"readv2"},{"code":"B213000","system":"readv2"},{"code":"B136.00","system":"readv2"},{"code":"Byu6.00","system":"readv2"},{"code":"B583000","system":"readv2"},{"code":"B200100","system":"readv2"},{"code":"B18y200","system":"readv2"},{"code":"B312000","system":"readv2"},{"code":"ByuC100","system":"readv2"},{"code":"B062200","system":"readv2"},{"code":"B211.00","system":"readv2"},{"code":"B517000","system":"readv2"},{"code":"B411.00","system":"readv2"},{"code":"B074.00","system":"readv2"},{"code":"B582z00","system":"readv2"},{"code":"B04..00","system":"readv2"},{"code":"B33..15","system":"readv2"},{"code":"B521.00","system":"readv2"},{"code":"B33X.00","system":"readv2"},{"code":"B224000","system":"readv2"},{"code":"ZV10016","system":"readv2"},{"code":"ByuC800","system":"readv2"},{"code":"B241000","system":"readv2"},{"code":"B337000","system":"readv2"},{"code":"B4A1000","system":"readv2"},{"code":"B222z00","system":"readv2"},{"code":"B31z.00","system":"readv2"},{"code":"B587.00","system":"readv2"},{"code":"B03..00","system":"readv2"},{"code":"B500000","system":"readv2"},{"code":"ZV10017","system":"readv2"},{"code":"B336300","system":"readv2"},{"code":"B583100","system":"readv2"},{"code":"B333100","system":"readv2"},{"code":"B572.00","system":"readv2"},{"code":"B10z.00","system":"readv2"},{"code":"B03y.00","system":"readv2"}];
REQUIRED_CODES = 1;
with open(sys.argv[1], 'r') as file_in, open('charlson-comorbidities-potential-cases.csv', 'w', newline='') as file_out:
    csv_reader = csv.DictReader(file_in)
    csv_writer = csv.DictWriter(file_out, csv_reader.fieldnames + ["charlson-comorbidities-neopl---primary-identified"])
    csv_writer.writeheader();
    codes_identified = 0;
    for row in csv_reader:
        newRow = row.copy();
        for cell in row:
            # Iterate cell lists (e.g. codes)
            for item in re.findall(r'\(([^,]*)\,', row[cell]):
                if(item in list(map(lambda code: code['code'], codes))): codes_identified+=1;
                if(codes_identified>=REQUIRED_CODES):
                    newRow["charlson-comorbidities-neopl---primary-identified"] = "CASE";
                    break;
            if(codes_identified>=REQUIRED_CODES): break;
        if(codes_identified<REQUIRED_CODES):
            newRow["charlson-comorbidities-neopl---primary-identified"] = "UNK";
        codes_identified=0;
        csv_writer.writerow(newRow)
